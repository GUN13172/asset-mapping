# 主题切换功能修复总结

## 修复时间
2026-02-06

## 问题描述
1. 主题切换功能无法工作
2. 浅色主题下文字颜色太浅，看不清楚
3. 浅色主题下框的配色不协调

## 修复内容

### 1. Settings 组件修复
**文件**: `src/components/Settings.tsx`

**修改内容**:
- 添加 `theme` 到 useTheme hook 的解构中，获取当前主题状态
- 添加 `useEffect` 同步当前主题到表单
- 修改 `initialValues` 中的 theme 为动态值 `theme`（而不是硬编码的 `'light'`）
- 添加 `handleThemeChange` 函数，在 Select onChange 时立即切换主题
- 移除 `saveSettings` 中的主题切换逻辑（主题切换应该立即生效，不需要等保存）

**关键代码**:
```typescript
const { theme, setTheme } = useTheme();

// 同步当前主题到表单
useEffect(() => {
  form.setFieldValue('theme', theme);
}, [theme, form]);

// 主题切换处理 - 立即生效
const handleThemeChange = (newTheme: 'light' | 'dark' | 'system') => {
  console.log('🎨 Settings: 主题切换', newTheme);
  setTheme(newTheme);
  form.setFieldValue('theme', newTheme);
};

// Select 组件添加 onChange
<Select 
  options={themeOptions} 
  onChange={handleThemeChange}
/>
```

### 2. 浅色主题配色修复
**文件**: `src/styles/theme-light.css`

**修改内容**:
- 文字颜色改为深色，确保可读性：
  - `--text-primary: #0f172a` (深蓝黑色)
  - `--text-secondary: #334155` (深灰色)
  - `--text-muted: #64748b` (中灰色)
- 背景色调整为浅色：
  - `--bg-primary: #f8fafc` (浅灰白)
  - `--bg-secondary: #ffffff` (纯白)
- 边框颜色加深：
  - `--border-color: #cbd5e1` (中灰)
- 所有 Ant Design 组件的文字颜色覆盖为深色

**覆盖的组件**:
- Layout (Header, Sider)
- Menu
- Card
- Button
- Input / TextArea / Select
- Table
- Pagination
- Modal
- Tabs
- Message
- Empty
- Tooltip
- Popconfirm

### 3. 主题切换逻辑
**文件**: `src/hooks/useTheme.ts`

**工作流程**:
1. 从 localStorage 读取保存的主题（默认 'dark'）
2. 使用 `useEffect` 监听 theme 状态变化
3. 当 theme 变化时，调用 `applyTheme` 函数
4. `applyTheme` 处理 'system' 主题（检测系统偏好）
5. 设置 `document.documentElement.setAttribute('data-theme', effectiveTheme)`
6. 保存到 localStorage

**关键代码**:
```typescript
const applyTheme = (newTheme: ThemeType) => {
  let effectiveTheme = newTheme;

  if (newTheme === 'system') {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    effectiveTheme = prefersDark ? 'dark' : 'light';
  }

  document.documentElement.setAttribute('data-theme', effectiveTheme);
  localStorage.setItem('app-theme', newTheme);
};
```

### 4. CSS 选择器机制
**工作原理**:
- 使用 `[data-theme="light"]` 和 `[data-theme="dark"]` 属性选择器
- 深色主题使用 `:root` 定义变量（默认）
- 浅色主题使用 `[data-theme="light"]` 覆盖变量
- 所有组件通过 CSS 变量引用颜色值

## 测试步骤

### 1. 启动应用
```bash
cd asset-mapping
npm run tauri dev
```

### 2. 测试主题切换
1. 打开应用，进入"设置"页面
2. 找到"主题"下拉选择器
3. 选择"浅色"，观察界面立即切换到浅色主题
4. 选择"深色"，观察界面立即切换到深色主题
5. 选择"跟随系统"，观察界面根据系统主题切换

### 3. 验证浅色主题可读性
在浅色主题下，检查以下内容：
- [ ] 所有文字清晰可读（深色文字）
- [ ] 输入框文字清晰可见
- [ ] 表格内容清晰可读
- [ ] 按钮文字清晰可见
- [ ] 卡片标题和内容清晰可读
- [ ] 菜单项文字清晰可见
- [ ] 下拉选项文字清晰可读

### 4. 验证深色主题
在深色主题下，检查以下内容：
- [ ] 所有文字清晰可读（浅色文字）
- [ ] 背景色协调
- [ ] 渐变效果正常
- [ ] 发光效果正常

### 5. 验证主题持久化
1. 切换到浅色主题
2. 关闭应用
3. 重新打开应用
4. 验证主题保持为浅色

## 技术要点

### 1. 立即生效 vs 保存后生效
- **立即生效**: 用户体验更好，选择主题后立即看到效果
- **实现方式**: 在 Select 的 onChange 中调用 setTheme
- **持久化**: 通过 localStorage 自动保存

### 2. CSS 变量的优势
- 统一管理颜色
- 易于主题切换
- 减少重复代码
- 便于维护

### 3. Ant Design 主题集成
- 使用 ConfigProvider 的 theme.algorithm
- 深色主题: `theme.darkAlgorithm`
- 浅色主题: `theme.defaultAlgorithm`
- 自定义 token 覆盖默认颜色

### 4. 调试技巧
- 使用 console.log 追踪主题切换流程
- 使用浏览器开发者工具检查 data-theme 属性
- 使用浏览器开发者工具检查 CSS 变量值
- 使用浏览器开发者工具检查元素的实际颜色

## 文件清单

### 修改的文件
1. `src/components/Settings.tsx` - 主题切换逻辑
2. `src/styles/theme-light.css` - 浅色主题样式

### 相关文件
1. `src/hooks/useTheme.ts` - 主题管理 hook
2. `src/App.tsx` - 主题应用到 ConfigProvider
3. `src/main.tsx` - CSS 文件导入
4. `src/styles/theme.css` - 深色主题样式

## 注意事项

1. **主题切换立即生效**: 不需要点击"保存设置"按钮
2. **主题自动保存**: 切换主题后会自动保存到 localStorage
3. **系统主题**: 选择"跟随系统"时，会根据操作系统的主题偏好自动切换
4. **浅色主题文字**: 必须使用深色文字确保可读性
5. **深色主题文字**: 必须使用浅色文字确保可读性

## 下一步优化建议

1. **更多主题**: 可以添加更多预设主题（如蓝色、绿色等）
2. **自定义主题**: 允许用户自定义颜色
3. **主题预览**: 在设置页面显示主题预览
4. **平滑过渡**: 添加主题切换的过渡动画
5. **高对比度模式**: 为视力障碍用户提供高对比度主题

## 总结

本次修复解决了主题切换功能的核心问题：
1. ✅ 主题切换立即生效
2. ✅ 浅色主题文字清晰可读
3. ✅ 浅色主题配色协调
4. ✅ 主题持久化保存
5. ✅ 支持跟随系统主题

用户现在可以流畅地在浅色和深色主题之间切换，所有文字和界面元素都清晰可读。
