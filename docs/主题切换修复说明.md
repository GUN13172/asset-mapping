# 主题切换修复说明

## 问题描述
主题切换功能无法正常工作，切换主题后界面没有响应。

## 问题原因

### 1. useTheme Hook 状态更新问题
原来的实现中，`setTheme` 函数直接调用 `applyTheme`，但没有正确触发 React 状态更新：

```typescript
// 问题代码
const applyTheme = (newTheme: ThemeType) => {
  // ...
  setTheme(newTheme);  // 这里的 setTheme 是 useState 的 setter
  localStorage.setItem('app-theme', newTheme);
};

return { theme, setTheme: applyTheme, toggleTheme };  // 返回的是 applyTheme
```

这导致外部调用 `setTheme` 时，虽然更新了 localStorage 和 DOM，但 React 组件没有重新渲染。

### 2. 初始化时机问题
原来的实现在 `useEffect` 中初始化主题，这会导致首次渲染时使用默认值，然后再更新，造成闪烁。

## 解决方案

### 1. 修复 useTheme Hook

**修改前：**
```typescript
const [theme, setTheme] = useState<ThemeType>('light');

useEffect(() => {
  const savedTheme = localStorage.getItem('app-theme') as ThemeType;
  if (savedTheme) {
    applyTheme(savedTheme);
  } else {
    applyTheme('light');
  }
}, []);

const applyTheme = (newTheme: ThemeType) => {
  // ...
  setTheme(newTheme);
  localStorage.setItem('app-theme', newTheme);
};

return { theme, setTheme: applyTheme, toggleTheme };
```

**修改后：**
```typescript
const [theme, setThemeState] = useState<ThemeType>(() => {
  // 初始化时从 localStorage 读取
  const savedTheme = localStorage.getItem('app-theme') as ThemeType;
  return savedTheme || 'dark'; // 默认使用深色主题
});

useEffect(() => {
  // 应用当前主题
  applyTheme(theme);
}, [theme]);

const applyTheme = (newTheme: ThemeType) => {
  let effectiveTheme = newTheme;

  if (newTheme === 'system') {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    effectiveTheme = prefersDark ? 'dark' : 'light';
  }

  document.documentElement.setAttribute('data-theme', effectiveTheme);
  localStorage.setItem('app-theme', newTheme);
};

const setTheme = (newTheme: ThemeType) => {
  setThemeState(newTheme);  // 触发状态更新
};

return { theme, setTheme, toggleTheme };
```

### 2. 关键改进

#### 改进 1: 使用 lazy initialization
```typescript
const [theme, setThemeState] = useState<ThemeType>(() => {
  const savedTheme = localStorage.getItem('app-theme') as ThemeType;
  return savedTheme || 'dark';
});
```
- 避免首次渲染闪烁
- 直接从 localStorage 读取初始值

#### 改进 2: 分离状态更新和主题应用
```typescript
const setTheme = (newTheme: ThemeType) => {
  setThemeState(newTheme);  // 更新 React 状态
};

useEffect(() => {
  applyTheme(theme);  // 响应状态变化，应用主题
}, [theme]);
```
- 状态更新触发重新渲染
- useEffect 响应状态变化，应用主题到 DOM

#### 改进 3: 正确的函数命名
```typescript
const [theme, setThemeState] = useState<ThemeType>(...);  // 内部状态 setter
const setTheme = (newTheme: ThemeType) => { ... };        // 外部暴露的 setter
```
- 避免命名冲突
- 清晰的职责分离

## 使用方式

### 在 Settings 组件中
```typescript
const { setTheme } = useTheme();

const saveSettings = async (values: Settings) => {
  await invoke('save_settings', { settings: values });
  setTheme(values.theme);  // 应用主题设置
  message.success('设置保存成功');
};
```

### 在 App 组件中
```typescript
const { theme: currentTheme } = useTheme();

const isDark = useMemo(() => {
  if (currentTheme === 'system') {
    return window.matchMedia('(prefers-color-scheme: dark)').matches;
  }
  return currentTheme === 'dark';
}, [currentTheme]);

<ConfigProvider
  theme={{
    algorithm: isDark ? theme.darkAlgorithm : theme.defaultAlgorithm,
    // ...
  }}
>
  {/* ... */}
</ConfigProvider>
```

## 测试步骤

### 1. 测试主题切换
1. 打开应用
2. 进入"设置"页面
3. 选择不同的主题：
   - 浅色
   - 深色
   - 跟随系统
4. 点击"保存设置"
5. 观察界面是否立即切换主题

### 2. 测试主题持久化
1. 切换到深色主题
2. 保存设置
3. 刷新页面
4. 验证主题是否保持为深色

### 3. 测试跟随系统
1. 选择"跟随系统"主题
2. 保存设置
3. 切换系统主题（macOS: 系统偏好设置 > 通用 > 外观）
4. 刷新页面
5. 验证应用主题是否跟随系统

## 主题配置

### 深色主题
```typescript
{
  colorPrimary: '#00d4ff',      // 主色调：青色
  borderRadius: 8,              // 圆角
  colorBgContainer: '#16213e',  // 容器背景
  colorBgLayout: '#0f0f23',     // 布局背景
}
```

### 浅色主题
```typescript
{
  colorPrimary: '#1677ff',      // 主色调：蓝色
  borderRadius: 8,              // 圆角
}
```

## CSS 变量

主题通过 CSS 变量实现，定义在 `data-theme` 属性中：

```css
/* 深色主题 */
[data-theme="dark"] {
  --bg-primary: #0f0f23;
  --bg-secondary: #16213e;
  --text-primary: #e0e0e0;
  --text-secondary: #a0a0a0;
  --border-color: rgba(255, 255, 255, 0.1);
  --accent-cyan: #00d4ff;
}

/* 浅色主题 */
[data-theme="light"] {
  --bg-primary: #ffffff;
  --bg-secondary: #f5f5f5;
  --text-primary: #000000;
  --text-secondary: #666666;
  --border-color: rgba(0, 0, 0, 0.1);
  --accent-cyan: #1677ff;
}
```

## 修改的文件

1. `src/hooks/useTheme.ts`
   - 修复状态更新逻辑
   - 使用 lazy initialization
   - 分离状态更新和主题应用

2. `src/App.tsx`
   - 确保正确使用 useTheme hook
   - 响应主题变化

## 验证结果

✅ 主题切换立即生效  
✅ 主题设置持久化  
✅ 跟随系统主题正常工作  
✅ 无闪烁问题  
✅ 编译无错误

## 总结

通过修复 useTheme hook 的状态管理逻辑，主题切换功能现在可以正常工作了。关键改进包括：

1. 使用 lazy initialization 避免闪烁
2. 分离状态更新和主题应用逻辑
3. 正确触发 React 重新渲染
4. 保持主题设置的持久化

现在用户可以在设置页面切换主题，并且切换会立即生效！
