# 主题切换测试指南

## 修复内容

### 1. 添加浅色主题 CSS 导入
在 `src/main.tsx` 中添加了 `theme-light.css` 的导入：

```typescript
import './styles/theme.css';
import './styles/theme-light.css';  // ← 新增
```

### 2. 添加调试日志
在 `useTheme` hook 中添加了详细的调试日志，方便追踪主题切换过程：

```typescript
console.log('🎨 初始化主题:', savedTheme || 'dark');
console.log('🎨 应用主题:', theme);
console.log('🎨 切换主题:', theme, '->', newTheme);
console.log('🎨 设置 data-theme 属性:', effectiveTheme);
console.log('🎨 保存主题到 localStorage:', newTheme);
```

## 测试步骤

### 步骤 1: 启动应用
```bash
cd asset-mapping
npm run tauri dev
```

### 步骤 2: 打开浏览器控制台
1. 在应用中按 `Cmd+Option+I` (macOS) 或 `F12` (Windows/Linux)
2. 切换到 Console 标签页
3. 观察主题相关的日志输出

### 步骤 3: 测试主题切换

#### 测试 1: 切换到浅色主题
1. 点击左侧菜单的"设置"
2. 在"主题"下拉框中选择"浅色"
3. 点击"保存设置"按钮
4. 观察：
   - 控制台应该输出：`🎨 切换主题: dark -> light`
   - 控制台应该输出：`🎨 设置 data-theme 属性: light`
   - 界面应该立即变为浅色主题

#### 测试 2: 切换到深色主题
1. 在"主题"下拉框中选择"深色"
2. 点击"保存设置"按钮
3. 观察：
   - 控制台应该输出：`🎨 切换主题: light -> dark`
   - 控制台应该输出：`🎨 设置 data-theme 属性: dark`
   - 界面应该立即变为深色主题

#### 测试 3: 跟随系统主题
1. 在"主题"下拉框中选择"跟随系统"
2. 点击"保存设置"按钮
3. 观察：
   - 控制台应该输出：`🎨 切换主题: dark -> system`
   - 控制台应该输出：`🎨 系统主题检测: light` 或 `dark`
   - 界面应该跟随系统主题

### 步骤 4: 测试主题持久化

#### 测试 4.1: 刷新页面
1. 切换到浅色主题并保存
2. 刷新页面 (Cmd+R 或 F5)
3. 观察：
   - 控制台应该输出：`🎨 初始化主题: light`
   - 界面应该保持浅色主题

#### 测试 4.2: 重启应用
1. 切换到深色主题并保存
2. 关闭应用
3. 重新启动应用
4. 观察：
   - 界面应该保持深色主题

### 步骤 5: 检查 HTML 属性

#### 使用浏览器开发者工具
1. 打开开发者工具
2. 切换到 Elements 标签页
3. 查看 `<html>` 元素
4. 观察 `data-theme` 属性：
   - 浅色主题：`<html data-theme="light">`
   - 深色主题：`<html data-theme="dark">`

#### 使用控制台
```javascript
// 在控制台中执行
document.documentElement.getAttribute('data-theme')
// 应该返回 'light' 或 'dark'
```

### 步骤 6: 检查 localStorage

#### 使用浏览器开发者工具
1. 打开开发者工具
2. 切换到 Application 标签页
3. 展开 Local Storage
4. 查看 `app-theme` 键的值

#### 使用控制台
```javascript
// 在控制台中执行
localStorage.getItem('app-theme')
// 应该返回 'light', 'dark', 或 'system'
```

## 预期结果

### 浅色主题效果
- ✅ 背景色变为白色/浅灰色
- ✅ 文字颜色变为深色
- ✅ 卡片背景变为白色
- ✅ 边框颜色变为浅灰色
- ✅ 按钮和强调色使用浅色主题配色
- ✅ 滚动条变为浅色

### 深色主题效果
- ✅ 背景色变为深蓝色/黑色
- ✅ 文字颜色变为浅色
- ✅ 卡片背景使用玻璃态效果
- ✅ 边框颜色使用半透明白色
- ✅ 按钮和强调色使用青色渐变
- ✅ 滚动条使用渐变色

### 跟随系统主题
- ✅ 自动检测系统主题设置
- ✅ 根据系统主题应用对应的浅色或深色主题
- ✅ 系统主题变化时自动更新（需要刷新页面）

## 调试技巧

### 如果主题没有切换

#### 检查 1: 查看控制台日志
```
🎨 初始化主题: dark
🎨 应用主题: dark
🎨 设置 data-theme 属性: dark
🎨 保存主题到 localStorage: dark
```

如果看不到这些日志，说明 `useTheme` hook 没有被正确调用。

#### 检查 2: 验证 HTML 属性
```javascript
// 在控制台执行
document.documentElement.getAttribute('data-theme')
```

如果返回 `null` 或错误的值，说明主题没有被正确应用。

#### 检查 3: 验证 CSS 文件加载
```javascript
// 在控制台执行
getComputedStyle(document.documentElement).getPropertyValue('--bg-primary')
```

应该返回颜色值，如 `#0f0f23` (深色) 或 `#ffffff` (浅色)。

#### 检查 4: 手动设置主题
```javascript
// 在控制台执行
document.documentElement.setAttribute('data-theme', 'light')
```

如果手动设置后主题切换成功，说明问题在于 React 状态管理。

### 如果主题切换有延迟

这是正常的，因为：
1. React 状态更新是异步的
2. useEffect 在下一次渲染时执行
3. CSS 变量应用需要浏览器重绘

通常延迟不超过 100ms，用户感知不到。

### 如果主题不持久化

#### 检查 localStorage
```javascript
// 在控制台执行
localStorage.getItem('app-theme')
```

如果返回 `null`，说明主题没有被保存。

#### 清除 localStorage 重新测试
```javascript
// 在控制台执行
localStorage.removeItem('app-theme')
location.reload()
```

## 常见问题

### Q1: 为什么切换主题后部分组件没有变化？

**A**: 可能是因为：
1. 组件使用了硬编码的颜色值
2. 组件没有使用 CSS 变量
3. 组件的样式优先级更高

**解决方案**: 检查组件的样式，确保使用 CSS 变量：
```css
/* 正确 */
background: var(--bg-primary);
color: var(--text-primary);

/* 错误 */
background: #0f0f23;
color: #ffffff;
```

### Q2: 为什么 Ant Design 组件没有跟随主题？

**A**: Ant Design 组件通过 `ConfigProvider` 的 `theme` 属性控制。

**解决方案**: 确保 `App.tsx` 中的 `isDark` 变量正确响应主题变化：
```typescript
const { theme: currentTheme } = useTheme();

const isDark = useMemo(() => {
  if (currentTheme === 'system') {
    return window.matchMedia('(prefers-color-scheme: dark)').matches;
  }
  return currentTheme === 'dark';
}, [currentTheme]);

<ConfigProvider
  theme={{
    algorithm: isDark ? theme.darkAlgorithm : theme.defaultAlgorithm,
    // ...
  }}
>
```

### Q3: 为什么刷新页面后主题恢复默认？

**A**: 可能是 localStorage 没有正确保存或读取。

**解决方案**: 
1. 检查浏览器是否允许 localStorage
2. 检查是否在隐私模式下运行
3. 清除浏览器缓存重试

### Q4: 如何添加新的主题？

**A**: 
1. 在 `useTheme.ts` 中添加新的主题类型
2. 创建新的 CSS 文件定义主题变量
3. 在 `main.tsx` 中导入新的 CSS 文件
4. 在 Settings 组件中添加新的主题选项

## 生产环境注意事项

### 移除调试日志

在生产环境中，应该移除 `console.log` 调试日志：

```typescript
// 开发环境
if (process.env.NODE_ENV === 'development') {
  console.log('🎨 切换主题:', theme, '->', newTheme);
}

// 或者使用条件编译
const DEBUG = false;
if (DEBUG) {
  console.log('🎨 切换主题:', theme, '->', newTheme);
}
```

### 性能优化

1. 使用 CSS 变量而不是动态样式
2. 避免在主题切换时重新渲染整个应用
3. 使用 `useMemo` 缓存计算结果

## 总结

主题切换功能现在应该可以正常工作了！关键修复包括：

1. ✅ 导入浅色主题 CSS 文件
2. ✅ 修复 useTheme hook 的状态管理
3. ✅ 添加调试日志方便追踪
4. ✅ 确保 HTML 属性正确设置
5. ✅ 确保 localStorage 正确保存和读取

如果还有问题，请查看控制台日志并按照上述调试步骤排查。
