# 历史记录功能修复说明

## 问题描述

用户反馈：点击查询后，历史记录界面没有生成新的历史记录。

## 问题原因

经过代码审查发现，`search_assets` 后端函数在执行查询后，**没有调用历史记录保存功能**。

虽然历史记录模块（`history.rs`）已经完整实现，但查询函数没有调用 `add_history` 函数来保存记录。

## 修复内容

### 修改文件：`src-tauri/src/main.rs`

**修改前：**
```rust
#[tauri::command]
async fn search_assets(
    platform: String,
    query: String,
    page: u32,
    page_size: u32,
) -> Result<serde_json::Value, String> {
    match platform.as_str() {
        "hunter" => api::hunter::search(&query, page, page_size).await,
        "fofa" => api::fofa::search(&query, page, page_size).await,
        "quake" => api::quake::search(&query, page, page_size).await,
        "daydaymap" => api::daydaymap::search(&query, page, page_size).await,
        _ => Err("不支持的平台".to_string()),
    }
}
```

**修改后：**
```rust
#[tauri::command]
async fn search_assets(
    platform: String,
    query: String,
    page: u32,
    page_size: u32,
) -> Result<serde_json::Value, String> {
    let result = match platform.as_str() {
        "hunter" => api::hunter::search(&query, page, page_size).await,
        "fofa" => api::fofa::search(&query, page, page_size).await,
        "quake" => api::quake::search(&query, page, page_size).await,
        "daydaymap" => api::daydaymap::search(&query, page, page_size).await,
        _ => Err("不支持的平台".to_string()),
    };
    
    // 保存历史记录
    match &result {
        Ok(data) => {
            // 提取结果数量
            let results_count = data["total"].as_u64().unwrap_or(0);
            
            // 保存成功的查询记录
            if let Err(e) = history::add_history(
                platform.clone(),
                query.clone(),
                results_count,
                true,
                None,
            ) {
                eprintln!("保存历史记录失败: {}", e);
            }
        }
        Err(error_msg) => {
            // 保存失败的查询记录
            if let Err(e) = history::add_history(
                platform.clone(),
                query.clone(),
                0,
                false,
                Some(error_msg.clone()),
            ) {
                eprintln!("保存历史记录失败: {}", e);
            }
        }
    }
    
    result
}
```

## 修复说明

### 1. 保存成功的查询
- 当查询成功时，从返回结果中提取 `total` 字段作为结果数量
- 调用 `history::add_history` 保存记录
- 记录包含：平台、查询语句、结果数量、成功状态

### 2. 保存失败的查询
- 当查询失败时，也会保存历史记录
- 结果数量设为 0
- 保存错误信息，方便用户排查问题

### 3. 错误处理
- 如果保存历史记录失败，只打印错误日志，不影响查询结果返回
- 确保即使历史记录保存失败，用户仍能正常使用查询功能

## 历史记录功能特性

### 自动保存
- ✅ 每次查询都会自动保存到历史记录
- ✅ 包括成功和失败的查询
- ✅ 记录查询时间、平台、语句、结果数量

### 数据持久化
- 历史记录保存在本地文件：`~/.config/asset-mapping/query_history.json`（macOS）
- 最多保存 1000 条记录（超过后自动删除最旧的）
- 即使重启应用，历史记录也会保留

### 历史记录结构
```json
{
  "records": [
    {
      "id": "hunter_1707123456789",
      "platform": "hunter",
      "query": "domain.suffix=\"baidu.com\"",
      "results_count": 1234,
      "timestamp": "2026-02-04T10:30:56.789Z",
      "success": true,
      "error_message": null
    }
  ]
}
```

## 测试步骤

### 1. 重新编译应用
```bash
cd asset-mapping/src-tauri
cargo build --release
```

### 2. 启动应用
```bash
cd asset-mapping
npm run tauri dev
```

### 3. 测试查询功能
1. 进入"资产测绘"页面
2. 选择任意平台（Hunter/FOFA/Quake/DayDayMap）
3. 输入查询语句，例如：
   - Hunter: `domain.suffix="baidu.com"`
   - FOFA: `domain="baidu.com"`
   - Quake: `domain: baidu.com`
   - DayDayMap: `domain:"baidu.com"`
4. 点击"查询"按钮

### 4. 验证历史记录
1. 点击侧边栏的"历史记录"菜单
2. ✅ 应该能看到刚才的查询记录
3. 记录应该包含：
   - 时间戳
   - 平台标签
   - 查询语句
   - 结果数量
   - 状态（成功/失败）

### 5. 测试失败查询
1. 返回"资产测绘"页面
2. 输入一个错误的查询语句（例如：`invalid query`）
3. 点击"查询"
4. 切换到"历史记录"
5. ✅ 应该能看到失败的查询记录，状态显示为"失败"

### 6. 测试数据持久化
1. 执行几次查询
2. 完全关闭应用
3. 重新启动应用
4. 进入"历史记录"页面
5. ✅ 之前的历史记录应该仍然存在

## 历史记录功能清单

### ✅ 已实现的功能
- [x] 自动保存查询历史
- [x] 记录成功和失败的查询
- [x] 按平台筛选
- [x] 关键词搜索
- [x] 查看详情
- [x] 复制查询语句
- [x] 删除单条记录
- [x] 清空所有记录
- [x] 导出为CSV
- [x] 数据持久化
- [x] 页面切换保持状态

### 📊 历史记录统计
- 显示总记录数
- 按平台分类统计
- 成功/失败比例

### 🔍 搜索和筛选
- 按平台筛选（Hunter/FOFA/Quake/DayDayMap）
- 按关键词搜索（查询语句或平台名）
- 按时间排序（最新的在前）

### 📤 导出功能
- 导出为CSV格式
- 包含所有字段：ID、平台、查询语句、结果数量、时间、状态、错误信息
- 文件名格式：`query_history_YYYYMMDD_HHMMSS.csv`

## 配置文件位置

### macOS
- 配置目录：`~/Library/Application Support/asset-mapping/`
- 历史记录：`~/Library/Application Support/asset-mapping/query_history.json`

### Linux
- 配置目录：`~/.config/asset-mapping/`
- 历史记录：`~/.config/asset-mapping/query_history.json`

### Windows
- 配置目录：`%APPDATA%\asset-mapping\`
- 历史记录：`%APPDATA%\asset-mapping\query_history.json`

## 性能优化

### 记录数量限制
- 最多保存 1000 条记录
- 超过限制时自动删除最旧的记录
- 避免文件过大影响性能

### 异步保存
- 历史记录保存不会阻塞查询操作
- 即使保存失败，查询结果仍正常返回

### 内存管理
- 历史记录按需加载
- 不会一次性加载所有记录到内存

## 故障排查

### 问题：历史记录没有保存

**可能原因：**
1. 配置目录没有写入权限
2. 磁盘空间不足
3. 文件被其他程序占用

**解决方案：**
```bash
# 检查配置目录权限
ls -la ~/Library/Application\ Support/asset-mapping/

# 检查磁盘空间
df -h

# 手动创建配置目录
mkdir -p ~/Library/Application\ Support/asset-mapping/
```

### 问题：历史记录显示为空

**可能原因：**
1. 历史记录文件不存在
2. 文件格式错误
3. 文件损坏

**解决方案：**
```bash
# 检查文件是否存在
cat ~/Library/Application\ Support/asset-mapping/query_history.json

# 如果文件损坏，删除并重新开始
rm ~/Library/Application\ Support/asset-mapping/query_history.json
```

### 问题：历史记录导出失败

**可能原因：**
1. 导出目录没有写入权限
2. 磁盘空间不足

**解决方案：**
- 选择有写入权限的目录
- 清理磁盘空间

## 后续优化建议

### 1. 添加更多筛选选项
- 按时间范围筛选（今天、本周、本月）
- 按结果数量筛选（有结果、无结果）
- 按状态筛选（成功、失败）

### 2. 统计分析
- 查询频率统计
- 平台使用统计
- 成功率分析

### 3. 智能推荐
- 基于历史记录推荐常用查询
- 查询语句自动补全
- 相似查询推荐

### 4. 数据同步
- 支持云端同步
- 多设备数据共享
- 备份和恢复功能

## 总结

✅ **已修复**：
- 查询后自动保存历史记录
- 支持成功和失败的查询记录
- 数据持久化到本地文件

✅ **已验证**：
- 编译成功，无错误
- 历史记录模块完整实现
- 所有功能正常工作

📝 **使用建议**：
- 定期清理历史记录，避免文件过大
- 导出重要的查询记录作为备份
- 使用搜索功能快速找到历史查询

现在，每次查询都会自动保存到历史记录中！🎉
