# è¿›åº¦å¼¹çª—é›†æˆå®ŒæˆæŠ¥å‘Š

## å®Œæˆæ—¶é—´
2026å¹´2æœˆ6æ—¥

## ä»»åŠ¡æ¦‚è¿°
æˆåŠŸå°† ProgressModal è¿›åº¦å¼¹çª—ç»„ä»¶é›†æˆåˆ° AssetQuery å’Œ ExportData ç»„ä»¶ä¸­ï¼Œå®ç°äº†æœç´¢å’Œå¯¼å‡ºæ“ä½œçš„å®æ—¶è¿›åº¦æ˜¾ç¤ºã€‚

## å®Œæˆçš„å·¥ä½œ

### âœ… 1. AssetQuery.tsx é›†æˆ

#### æ·»åŠ çš„çŠ¶æ€ç®¡ç†
```typescript
// æœç´¢è¿›åº¦å¼¹çª—çŠ¶æ€
const [searchModalOpen, setSearchModalOpen] = useState(false);
const [searchStatus, setSearchStatus] = useState<ProgressStatus>('idle');
const [searchPercent, setSearchPercent] = useState(0);
const [searchStatusText, setSearchStatusText] = useState('');
const [searchLogs, setSearchLogs] = useState<ProgressLog[]>([]);

// å¯¼å‡ºè¿›åº¦å¼¹çª—çŠ¶æ€
const [exportModalOpen, setExportModalOpen] = useState(false);
const [exportStatus, setExportStatus] = useState<ProgressStatus>('idle');
const [exportPercent, setExportPercent] = useState(0);
const [exportStatusText, setExportStatusText] = useState('');
const [exportLogs, setExportLogs] = useState<ProgressLog[]>([]);
const [exportSummary, setExportSummary] = useState<{ label: string; value: string | number }[]>([]);
```

#### æ·»åŠ çš„äº‹ä»¶ç›‘å¬
- ç›‘å¬ `export-progress` äº‹ä»¶
- è‡ªåŠ¨æ›´æ–°è¿›åº¦ã€çŠ¶æ€ã€æ—¥å¿—å’Œæ‘˜è¦ä¿¡æ¯
- ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†ç›‘å¬å™¨

#### ä¿®æ”¹çš„åŠŸèƒ½

**æœç´¢åŠŸèƒ½ (handleSearch)**
- æ˜¾ç¤ºæœç´¢è¿›åº¦å¼¹çª—
- å®æ—¶æ›´æ–°æœç´¢çŠ¶æ€
- è®°å½•æœç´¢æ—¥å¿—
- æ˜¾ç¤ºæŸ¥è¯¢ç»“æœç»Ÿè®¡

**å¯¼å‡ºåŠŸèƒ½ (exportResults)**
- ä½¿ç”¨ `export_results_with_progress` å‘½ä»¤
- æ˜¾ç¤ºå¯¼å‡ºè¿›åº¦å¼¹çª—
- å®æ—¶æ›´æ–°å¯¼å‡ºè¿›åº¦
- è®°å½•å¯¼å‡ºæ—¥å¿—å’Œç»Ÿè®¡ä¿¡æ¯

#### æ·»åŠ çš„ UI ç»„ä»¶
```tsx
{/* æœç´¢è¿›åº¦å¼¹çª— */}
<ProgressModal
  open={searchModalOpen}
  title="èµ„äº§æŸ¥è¯¢"
  status={searchStatus}
  percent={searchPercent}
  statusText={searchStatusText}
  logs={searchLogs}
  onClose={() => setSearchModalOpen(false)}
/>

{/* å¯¼å‡ºè¿›åº¦å¼¹çª— */}
<ProgressModal
  open={exportModalOpen}
  title="æ•°æ®å¯¼å‡º"
  status={exportStatus}
  percent={exportPercent}
  statusText={exportStatusText}
  logs={exportLogs}
  summary={exportSummary}
  onClose={() => setExportModalOpen(false)}
/>
```

### âœ… 2. ExportData.tsx é›†æˆ

#### æ·»åŠ çš„çŠ¶æ€ç®¡ç†
```typescript
// å¯¼å‡ºè¿›åº¦å¼¹çª—çŠ¶æ€
const [exportModalOpen, setExportModalOpen] = useState(false);
const [exportStatus, setExportStatus] = useState<ProgressStatus>('idle');
const [exportPercent, setExportPercent] = useState(0);
const [exportStatusText, setExportStatusText] = useState('');
const [exportLogs, setExportLogs] = useState<ProgressLog[]>([]);
const [exportSummary, setExportSummary] = useState<{ label: string; value: string | number }[]>([]);
```

#### æ·»åŠ çš„äº‹ä»¶ç›‘å¬
- ç›‘å¬ `export-progress` äº‹ä»¶
- è‡ªåŠ¨æ›´æ–°è¿›åº¦ã€çŠ¶æ€ã€æ—¥å¿—å’Œæ‘˜è¦ä¿¡æ¯
- ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†ç›‘å¬å™¨

#### ä¿®æ”¹çš„åŠŸèƒ½

**å¯¼å‡ºåŠŸèƒ½ (handleExport)**
- æ ¹æ®å¯¼å‡ºç±»å‹é€‰æ‹©ä¸åŒçš„å¤„ç†æ–¹å¼
- `current` å’Œ `platform` ç±»å‹ä½¿ç”¨ `export_results_with_progress`
- `all` ç±»å‹ä½¿ç”¨ `export_all_platforms`ï¼ˆæ‰‹åŠ¨æ¨¡æ‹Ÿè¿›åº¦ï¼‰
- æ˜¾ç¤ºå¯¼å‡ºè¿›åº¦å¼¹çª—
- å®æ—¶æ›´æ–°å¯¼å‡ºçŠ¶æ€å’Œæ—¥å¿—

#### æ·»åŠ çš„ UI ç»„ä»¶
```tsx
{/* å¯¼å‡ºè¿›åº¦å¼¹çª— */}
<ProgressModal
  open={exportModalOpen}
  title="æ•°æ®å¯¼å‡º"
  status={exportStatus}
  percent={exportPercent}
  statusText={exportStatusText}
  logs={exportLogs}
  summary={exportSummary}
  onClose={() => setExportModalOpen(false)}
/>
```

### âœ… 3. ç¼–è¯‘éªŒè¯

#### TypeScript ç¼–è¯‘
```bash
âœ“ æ— ç±»å‹é”™è¯¯
âœ“ æ— è¯­æ³•é”™è¯¯
```

#### Vite æ„å»º
```bash
âœ“ 3004 modules transformed
âœ“ built in 7.93s
âœ“ ç”Ÿæˆæ–‡ä»¶:
  - dist/index.html (0.45 kB)
  - dist/assets/index-4c0e790c.css (23.89 kB)
  - dist/assets/index-caf77d15.js (1,189.48 kB)
```

## åŠŸèƒ½ç‰¹æ€§

### æœç´¢è¿›åº¦æ˜¾ç¤º
- âœ… æ˜¾ç¤ºæŸ¥è¯¢çŠ¶æ€ï¼ˆå‡†å¤‡ä¸­ã€æŸ¥è¯¢ä¸­ã€æˆåŠŸã€å¤±è´¥ï¼‰
- âœ… æ˜¾ç¤ºè¿›åº¦ç™¾åˆ†æ¯”
- âœ… æ˜¾ç¤ºçŠ¶æ€æ–‡æœ¬
- âœ… è®°å½•æŸ¥è¯¢æ—¥å¿—
- âœ… æ˜¾ç¤ºæŸ¥è¯¢ç»“æœç»Ÿè®¡

### å¯¼å‡ºè¿›åº¦æ˜¾ç¤º
- âœ… æ˜¾ç¤ºå¯¼å‡ºçŠ¶æ€ï¼ˆå‡†å¤‡ä¸­ã€å¯¼å‡ºä¸­ã€æˆåŠŸã€å¤±è´¥ï¼‰
- âœ… æ˜¾ç¤ºè¿›åº¦ç™¾åˆ†æ¯”
- âœ… æ˜¾ç¤ºçŠ¶æ€æ–‡æœ¬
- âœ… è®°å½•å¯¼å‡ºæ—¥å¿—
- âœ… æ˜¾ç¤ºå¯¼å‡ºç»Ÿè®¡ä¿¡æ¯ï¼š
  - æ€»é¡µæ•°
  - å½“å‰é¡µ
  - æ€»ç»“æœæ•°
  - å·²è·å–æ•°é‡

### ç”¨æˆ·ä½“éªŒ
- âœ… å®æ—¶è¿›åº¦åé¦ˆ
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•
- âœ… æ¸…æ™°çš„çŠ¶æ€æŒ‡ç¤º
- âœ… å¯å…³é—­çš„å¼¹çª—
- âœ… è‡ªåŠ¨æ¸…ç†èµ„æº

## æŠ€æœ¯å®ç°

### äº‹ä»¶ç›‘å¬æœºåˆ¶
```typescript
useEffect(() => {
  const setupListener = async () => {
    unlistenRef.current = await listen<ProgressEventPayload>('export-progress', (event) => {
      const data = event.payload;
      // æ›´æ–°è¿›åº¦çŠ¶æ€
      setExportPercent(data.percent);
      setExportStatus(data.status as ProgressStatus);
      setExportStatusText(data.statusText);
      
      // æ·»åŠ æ—¥å¿—
      if (data.logMessage) {
        const now = new Date().toLocaleTimeString();
        setExportLogs(prev => [...prev, {
          time: now,
          message: data.logMessage!,
          type: (data.logType || 'info') as ProgressLog['type'],
        }]);
      }
      
      // æ›´æ–°æ‘˜è¦
      const summaryItems: { label: string; value: string | number }[] = [];
      if (data.totalPages != null) summaryItems.push({ label: 'æ€»é¡µæ•°', value: data.totalPages });
      if (data.currentPage != null) summaryItems.push({ label: 'å½“å‰é¡µ', value: data.currentPage });
      if (data.totalResults != null) summaryItems.push({ label: 'æ€»ç»“æœæ•°', value: data.totalResults });
      if (data.fetchedResults != null) summaryItems.push({ label: 'å·²è·å–', value: data.fetchedResults });
      if (summaryItems.length > 0) setExportSummary(summaryItems);
    });
  };
  setupListener();

  return () => {
    if (unlistenRef.current) {
      unlistenRef.current();
    }
  };
}, []);
```

### è¿›åº¦æ›´æ–°æµç¨‹
1. ç”¨æˆ·è§¦å‘æ“ä½œï¼ˆæœç´¢/å¯¼å‡ºï¼‰
2. æ‰“å¼€è¿›åº¦å¼¹çª—ï¼Œåˆå§‹åŒ–çŠ¶æ€
3. è°ƒç”¨åç«¯å‘½ä»¤ï¼ˆå¸¦ taskIdï¼‰
4. åç«¯å‘é€è¿›åº¦äº‹ä»¶
5. å‰ç«¯ç›‘å¬å™¨æ¥æ”¶äº‹ä»¶
6. æ›´æ–°è¿›åº¦çŠ¶æ€å’Œæ—¥å¿—
7. æ“ä½œå®Œæˆæˆ–å¤±è´¥
8. æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€

## æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶
1. `asset-mapping/src/components/AssetQuery.tsx`
   - æ·»åŠ æœç´¢è¿›åº¦å¼¹çª—
   - æ·»åŠ å¯¼å‡ºè¿›åº¦å¼¹çª—
   - é›†æˆäº‹ä»¶ç›‘å¬

2. `asset-mapping/src/components/ExportData.tsx`
   - æ·»åŠ å¯¼å‡ºè¿›åº¦å¼¹çª—
   - é›†æˆäº‹ä»¶ç›‘å¬
   - ä¿®æ”¹å¯¼å‡ºé€»è¾‘

### ç›¸å…³æ–‡ä»¶
3. `asset-mapping/src/components/ProgressModal.tsx`
   - è¿›åº¦å¼¹çª—ç»„ä»¶ï¼ˆå·²å­˜åœ¨ï¼‰

4. `asset-mapping/src-tauri/src/main.rs`
   - åç«¯å‘½ä»¤æ³¨å†Œï¼ˆå·²å®Œæˆï¼‰

## æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•
1. **æœç´¢åŠŸèƒ½æµ‹è¯•**
   - è¾“å…¥æŸ¥è¯¢æ¡ä»¶
   - ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®
   - è§‚å¯Ÿè¿›åº¦å¼¹çª—æ˜¾ç¤º
   - éªŒè¯æŸ¥è¯¢ç»“æœ

2. **å¯¼å‡ºåŠŸèƒ½æµ‹è¯•ï¼ˆAssetQueryï¼‰**
   - æ‰§è¡ŒæŸ¥è¯¢è·å¾—ç»“æœ
   - ç‚¹å‡»å¯¼å‡ºæŒ‰é’®
   - è§‚å¯Ÿå¯¼å‡ºè¿›åº¦
   - éªŒè¯å¯¼å‡ºæ–‡ä»¶

3. **å¯¼å‡ºåŠŸèƒ½æµ‹è¯•ï¼ˆExportDataï¼‰**
   - é€‰æ‹©å¯¼å‡ºç±»å‹
   - è¾“å…¥æŸ¥è¯¢æ¡ä»¶
   - è®¾ç½®å¯¼å‡ºå‚æ•°
   - ç‚¹å‡»å¼€å§‹å¯¼å‡º
   - è§‚å¯Ÿå¯¼å‡ºè¿›åº¦
   - éªŒè¯å¯¼å‡ºæ–‡ä»¶

### è¾¹ç•Œæµ‹è¯•
1. ç½‘ç»œé”™è¯¯å¤„ç†
2. API é…é¢è€—å°½å¤„ç†
3. å¤§é‡æ•°æ®å¯¼å‡º
4. ä¸­é€”å–æ¶ˆæ“ä½œ
5. å¤šæ¬¡å¿«é€Ÿç‚¹å‡»

## å·²çŸ¥é™åˆ¶

1. **å¯¼å‡ºæ‰€æœ‰å¹³å°åŠŸèƒ½**
   - ç›®å‰ä½¿ç”¨ `export_all_platforms` å‘½ä»¤
   - ä¸æ”¯æŒå®æ—¶è¿›åº¦äº‹ä»¶
   - æ‰‹åŠ¨æ¨¡æ‹Ÿè¿›åº¦æ˜¾ç¤º
   - å»ºè®®åç»­ä¼˜åŒ–ä¸ºæ”¯æŒè¿›åº¦äº‹ä»¶

2. **æœç´¢è¿›åº¦**
   - æœç´¢æ“ä½œé€šå¸¸å¾ˆå¿«
   - è¿›åº¦å¼¹çª—å¯èƒ½ä¸€é—ªè€Œè¿‡
   - ä¸»è¦ç”¨äºé”™è¯¯æç¤ºå’Œæ—¥å¿—è®°å½•

## åç»­ä¼˜åŒ–å»ºè®®

### 1. ä¼˜åŒ–å¯¼å‡ºæ‰€æœ‰å¹³å°åŠŸèƒ½
```rust
// å»ºè®®åœ¨åç«¯å®ç°å¸¦è¿›åº¦çš„ export_all_platforms
#[tauri::command]
async fn export_all_platforms_with_progress(
    task_id: String,
    window: Window,
    // ... å…¶ä»–å‚æ•°
) -> Result<Vec<String>, String> {
    // ä¸ºæ¯ä¸ªå¹³å°å‘é€è¿›åº¦äº‹ä»¶
    // è¿”å›æ‰€æœ‰å¯¼å‡ºæ–‡ä»¶è·¯å¾„
}
```

### 2. æ·»åŠ å–æ¶ˆåŠŸèƒ½
```typescript
// å‰ç«¯æ·»åŠ å–æ¶ˆæŒ‰é’®
<Button onClick={handleCancel}>å–æ¶ˆ</Button>

// åç«¯æ”¯æŒå–æ¶ˆæ“ä½œ
#[tauri::command]
async fn cancel_export(task_id: String) -> Result<(), String> {
    // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„å¯¼å‡ºä»»åŠ¡
}
```

### 3. æ·»åŠ æš‚åœ/æ¢å¤åŠŸèƒ½
```typescript
// æ”¯æŒæš‚åœå’Œæ¢å¤å¯¼å‡º
const [isPaused, setIsPaused] = useState(false);

const handlePause = async () => {
  await invoke('pause_export', { taskId });
  setIsPaused(true);
};

const handleResume = async () => {
  await invoke('resume_export', { taskId });
  setIsPaused(false);
};
```

### 4. æ·»åŠ è¿›åº¦æŒä¹…åŒ–
```typescript
// ä¿å­˜è¿›åº¦åˆ°æœ¬åœ°å­˜å‚¨
// é¡µé¢åˆ·æ–°åå¯ä»¥æ¢å¤è¿›åº¦
localStorage.setItem(`export_${taskId}`, JSON.stringify({
  percent: exportPercent,
  status: exportStatus,
  logs: exportLogs,
}));
```

### 5. ä¼˜åŒ–å¤§æ•°æ®å¯¼å‡º
- åˆ†æ‰¹å¯¼å‡º
- æµå¼å†™å…¥
- å‹ç¼©å¯¼å‡ºæ–‡ä»¶
- æ”¯æŒæ–­ç‚¹ç»­ä¼ 

## æ€»ç»“

âœ… **å·²å®Œæˆçš„å·¥ä½œ**
- AssetQuery ç»„ä»¶é›†æˆè¿›åº¦å¼¹çª—
- ExportData ç»„ä»¶é›†æˆè¿›åº¦å¼¹çª—
- äº‹ä»¶ç›‘å¬æœºåˆ¶å®ç°
- ç¼–è¯‘éªŒè¯é€šè¿‡

âœ… **åŠŸèƒ½ç‰¹æ€§**
- å®æ—¶è¿›åº¦æ˜¾ç¤º
- è¯¦ç»†æ—¥å¿—è®°å½•
- çŠ¶æ€æŒ‡ç¤ºæ¸…æ™°
- ç”¨æˆ·ä½“éªŒè‰¯å¥½

âœ… **ä»£ç è´¨é‡**
- æ— ç¼–è¯‘é”™è¯¯
- æ— ç±»å‹é”™è¯¯
- ä»£ç ç»“æ„æ¸…æ™°
- æ³¨é‡Šå®Œæ•´

ğŸ‰ **è¿›åº¦å¼¹çª—é›†æˆå·¥ä½œå…¨éƒ¨å®Œæˆï¼**

---

**å®Œæˆæ—¥æœŸ**: 2026å¹´2æœˆ6æ—¥  
**çŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆ  
**ç¼–è¯‘**: âœ… é€šè¿‡  
**æµ‹è¯•**: å¾…è¿›è¡Œ
